# Snakemake configuration for rtpipeline

# Input/Output directories
dicom_root: "Example_data"
output_dir: "Data_Snakemake"
logs_dir: "Logs_Snakemake"

# Processing parameters
# Default: auto (uses CPU count - 2, minimum 4)
# Set to a specific number to override (e.g., workers: 8)
workers: auto

segmentation:
  workers: 4  # TotalSegmentator concurrency (4 allows good CPU/GPU mix)
  threads_per_worker: null  # CPU threads allowed per TotalSegmentator invocation (null => no limit)
  force: false  # Set true to re-run segmentation even when outputs exist
  fast: false
  roi_subset: null
  extra_models: []   # Optional list of additional TotalSegmentator tasks, e.g. ["lung_vessels"]

custom_models:
  enabled: false       # SECURITY: Disabled by default - model weights are missing and will cause runtime failures
  root: "custom_models"
  models: []           # Optional allowlist of model names; leave empty to run all
  workers: 1           # Concurrent courses for custom models (GPU intensive; default 1, increase if multiple GPUs)
  force: false         # Force re-run even if outputs already exist
  nnunet_predict: "nnUNet_predict"
  retain_weights: true # Keep extracted nnUNet caches between runs (set false to purge after each run)
  conda_activate: null  # Override conda activation for custom models (default: segmentation setting)

radiomics:
  sequential: false
  params_file: "rtpipeline/radiomics_params.yaml"
  mr_params_file: "rtpipeline/radiomics_params_mr.yaml"
  thread_limit: 4  # CPU threads per radiomics worker (null => no limit)
  skip_rois:
    - body
    - couchsurface
    - couchinterior
    - couchexterior
    - bones
    - m1
    - m2
  max_voxels: 1500000000  # 1.5 billion voxels max (approx 1500x1000x1000)
  min_voxels: 10

aggregation:
  threads: auto  # auto = use CPU count, or set specific number

# Environment names
environments:
  main: "rtpipeline"          # NumPy 2.x for TotalSegmentator
  radiomics: "rtpipeline-radiomics"  # NumPy 1.x for PyRadiomics

# Custom structures configuration
custom_structures: "custom_structures_pelvic.yaml"

# Systematic CT cropping for consistent volume analysis
# Crops all CTs to same anatomical boundaries
# This makes percentage DVH metrics (V95%, V20Gy) meaningful across patients
ct_cropping:
  enabled: false  # Enable to crop CTs to consistent anatomical boundaries

  # Supported regions:
  #   "pelvis"     - L1 vertebra to femoral heads + margin
  #   "thorax"     - C7/lung apex to L1/diaphragm
  #   "abdomen"    - T12/L1 to L5 vertebra
  #   "head_neck"  - Brain/skull apex to C7/clavicles
  #   "brain"      - Brain boundaries (minimal margins)
  region: "pelvis"

  # Margins (in cm) - different defaults for different regions:
  superior_margin_cm: 2.0   # Margin above superior landmark (1 cm for brain, 2 cm for others)
  inferior_margin_cm: 10.0  # Margin below inferior landmark (1 cm for brain, 2 cm for thorax/abdomen/head_neck, 10 cm for pelvis)

  use_cropped_for_dvh: true       # Use cropped volumes for DVH analysis
  use_cropped_for_radiomics: true # Use cropped volumes for radiomics
  keep_original: true             # Keep original uncropped files
