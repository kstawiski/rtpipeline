# Snakemake configuration for rtpipeline

# Input/Output directories
dicom_root: "Example_data"
output_dir: "Data_Snakemake"
logs_dir: "Logs_Snakemake"

# Processing parameters
# Default: auto (uses CPU count - 2, minimum 4)
# Set to a specific number to override (e.g., workers: 8)
workers: auto

segmentation:
  workers: 4  # TotalSegmentator concurrency (4 allows good CPU/GPU mix)
  threads_per_worker: null  # CPU threads allowed per TotalSegmentator invocation (null => no limit)
  force: false  # Set true to re-run segmentation even when outputs exist
  fast: false
  roi_subset: null
  extra_models: []   # Optional list of additional TotalSegmentator tasks, e.g. ["lung_vessels"]
  device: "gpu"             # TotalSegmentator device: gpu / cpu / mps
  force_split: true         # Force chunked inference to reduce memory spikes
  nr_threads_resample: 1    # Threads used by TotalSegmentator during resampling
  nr_threads_save: 1        # Threads used when saving results
  num_proc_preprocessing: 1 # Multiprocessing workers for nnUNet preprocessing
  num_proc_export: 1        # Multiprocessing workers for nnUNet export

custom_models:
  enabled: false       # SECURITY: Disabled by default - model weights are missing and will cause runtime failures
  root: "custom_models"
  models: []           # Optional allowlist of model names; leave empty to run all
  workers: 1           # Concurrent courses for custom models (GPU intensive; default 1, increase if multiple GPUs)
  force: false         # Force re-run even if outputs already exist
  nnunet_predict: "nnUNet_predict"
  retain_weights: true # Keep extracted nnUNet caches between runs (set false to purge after each run)
  conda_activate: null  # Override conda activation for custom models (default: segmentation setting)

radiomics:
  sequential: false
  params_file: "rtpipeline/radiomics_params.yaml"
  mr_params_file: "rtpipeline/radiomics_params_mr.yaml"
  thread_limit: 4  # CPU threads per radiomics worker (null => no limit)
  skip_rois:
    - body
    - couchsurface
    - couchinterior
    - couchexterior
    - bones
    - m1
    - m2
  max_voxels: 1500000000  # 1.5 billion voxels max (approx 1500x1000x1000)
  min_voxels: 10

# Radiomics robustness analysis
# Evaluates feature stability under segmentation perturbations
# Based on IBSI guidelines and state-of-the-art methods (Zwanenburg 2019, Lo Iacono 2024)
radiomics_robustness:
  enabled: false  # Set to true to enable robustness analysis

  # Analysis modes to run
  modes:
    - segmentation_perturbation  # Mask erosion/dilation perturbations
    # - segmentation_method       # Compare different segmentation methods (future)
    # - scan_rescan               # Test-retest reliability (future)

  # Segmentation perturbation settings
  segmentation_perturbation:
    # Structures to analyze (supports wildcards: GTV*, CTV*, PTV*)
    # Works across ALL sources: TotalSegmentator, Custom structures, Custom models
    apply_to_structures:
      - "GTV*"              # Gross tumor volumes (from Custom or Manual)
      - "CTV*"              # Clinical target volumes (from Custom or Manual)
      - "PTV*"              # Planning target volumes (from Custom or Manual)
      - "pelvic_bones*"     # pelvic_bones, pelvic_bones_3mm (from Custom)
      - "iliac_*"           # iliac_vess, iliac_area (from Custom)
      - "bowel_bag"         # Combined bowel structures (from Custom)
      - "bladder"           # From TotalSegmentator (lowercase)
      - "rectum"            # From TotalSegmentator (lowercase)

    # Volume changes for perturbations (τ parameter)
    # Based on Lo Iacono et al. 2024: ±15% for stability assessment
    small_volume_changes: [-0.15, 0.0, 0.15]  # ±15% volume change

    # Optional: larger perturbations for robustness stress testing
    large_volume_changes: [-0.30, 0.0, 0.30]  # ±30% volume change

    # Advanced perturbations (currently disabled)
    n_random_contour_realizations: 0  # Number of boundary randomization variants
    max_translation_mm: 0.0           # Maximum rigid translation in mm

  # Robustness metrics configuration
  metrics:
    icc:
      implementation: "pingouin"  # Use Pingouin library for ICC computation
      icc_type: "ICC2"            # ICC(2,1): two-way mixed effects, absolute agreement
      ci: true                    # Compute 95% confidence intervals
    cov:
      enabled: true               # Coefficient of Variation (%)
    qcd:
      enabled: true               # Quartile Coefficient of Dispersion

  # Thresholds for classifying feature robustness
  # Based on Zwanenburg 2019 and Hosseini 2025 recommendations
  thresholds:
    icc:
      robust: 0.90       # ICC ≥ 0.90: "excellent/robust"
      acceptable: 0.75   # ICC ≥ 0.75: "good/acceptable"
                         # ICC < 0.75: "poor"
    cov:
      robust_pct: 10.0      # CoV ≤ 10%: "robust"
      acceptable_pct: 20.0  # CoV ≤ 20%: "acceptable"
                            # CoV > 20%: "poor"

aggregation:
  threads: auto  # auto = use CPU count, or set specific number

# Environment names
environments:
  main: "rtpipeline"          # NumPy 2.x for TotalSegmentator
  radiomics: "rtpipeline-radiomics"  # NumPy 1.x for PyRadiomics

# Custom structures configuration
custom_structures: "custom_structures_pelvic.yaml"

# Systematic CT cropping for consistent volume analysis
# Crops all CTs to same anatomical boundaries
# This makes percentage DVH metrics (V95%, V20Gy) meaningful across patients
ct_cropping:
  enabled: true  # Enable to crop CTs to consistent anatomical boundaries

  # Supported regions:
  #   "pelvis"     - L1 vertebra to femoral heads + margin
  #   "thorax"     - C7/lung apex to L1/diaphragm
  #   "abdomen"    - T12/L1 to L5 vertebra
  #   "head_neck"  - Brain/skull apex to C7/clavicles
  #   "brain"      - Brain boundaries (minimal margins)
  region: "pelvis"

  # Margins (in cm) - different defaults for different regions:
  superior_margin_cm: 2.0   # Margin above superior landmark (1 cm for brain, 2 cm for others)
  inferior_margin_cm: 10.0  # Margin below inferior landmark (1 cm for brain, 2 cm for thorax/abdomen/head_neck, 10 cm for pelvis)

  use_cropped_for_dvh: true       # Use cropped volumes for DVH analysis
  use_cropped_for_radiomics: true # Use cropped volumes for radiomics
  keep_original: true             # Keep original uncropped files
