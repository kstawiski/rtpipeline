# Metadata Outputs

The organisation stage collects a large amount of contextual information from
RTPLAN, RTDOSE, RTSTRUCT, CT, and treatment-record files. This information is
written both per patient and across the entire cohort so downstream analysis can
reuse it without re-reading DICOM.

## Global exports (`output_dir/Data/`)
Generated by `rtpipeline.meta.export_metadata`:
- `plans.xlsx` – RTPLAN attributes (labels, dates, approval status, referenced
  dose/CT identifiers, patient demographics).
- `dosimetrics.xlsx` – RTDOSE provenance (referenced plans, CT identifiers,
  patient IDs).
- `structure_sets.xlsx` – RTSTRUCT metadata with structure counts and plan
  linkage.
- `fractions.xlsx` – RT treatment record details (fraction IDs, machine,
  delivery timestamps) where available.
- `metadata.xlsx` – merged view linking plans, doses, and structure sets by
  shared identifiers.
- `CT_images.xlsx` – CT series inventory (study/series UIDs, slice counts, basic
  acquisition parameters).
- `case_metadata_all.{xlsx,json}` – concatenation of every per-course
  `case_metadata.json` file (see below).

## Per-patient metadata (`output_dir/<patient>/metadata.json`)
Produced inside the Snakemake `organize_data` rule. The file always contains:
- `patient_id` and canonicalised paths to the organised `CT_DICOM`, `RP.dcm`,
  `RD.dcm`, `RS.dcm` (if present), `RS_auto.dcm`, and `TotalSegmentator_NIFTI`.
- Any extra keys carried over from the temporary `case_metadata.json` produced
  by the CLI. This may include planning details, beam geometry summaries, or
  treatment timing depending on the available DICOM headers.

Later rules (DVH, radiomics, QC) rely on these paths, so treat
`metadata.json` as the single source of truth for where artefacts live.

## Course metadata (`case_metadata.json` / `.xlsx`)
Each organised course also receives a richer metadata dump describing:
- identification: patient ID, course key, absolute paths to key files.
- planning summary: plan label/date/time/intent, approval timestamps, planned
  fractions, machine name, derived beam statistics (gantry, collimator, couch
  angles, technique inference, meterset totals).
- prescriptions: dose reference entries plus per-ROI prescriptions when present.
- patient demographics: name, sex, birth date, weight/height/BMI, age at plan.
- dose grid information: voxel dimensions, frame counts, dose units/type.
- CT series context: manufacturer, model, convolution kernel, slice thickness,
  pixel spacing.
- structure inventory: ROI names with counts of PTV/CTV/OAR type heuristics.
- treatment timeline: earliest/latest treatment dates and count of delivered
  fractions derived from RT treatment records.

The JSON is easy to parse programmatically; the XLSX variant is convenient for
spot-checking in spreadsheet tools.

## Summaries produced by Snakemake
The `summarize` rule concatenates selected artefacts into research-ready tables
in the output root:
- `metadata_summary.xlsx` – flattened view of every `metadata.json`.
- `radiomics_summary.xlsx` – all per-patient `Radiomics_CT.xlsx` files with an
  extra `patient` column.
- `dvh_summary.xlsx` – combined DVH metrics across patients.

Quality-control JSON is similarly normalised by the `qc_summary` rule into
`qc_summary.xlsx`.
