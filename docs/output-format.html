<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Output Format - RTpipeline</title>
    <meta name="description" content="Definitive guide to RTpipeline outputs: Data_Snakemake directory layout, RTSTRUCT variants, DVH, radiomics, QC, and cohort summaries.">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">
                <span class="logo-icon">RT</span>
                <span class="logo-text">pipeline</span>
            </a>
            <ul class="nav-menu">
                <li><a href="getting-started.html">Getting Started</a></li>
                <li><a href="features.html">Features</a></li>
                <li><a href="configuration.html">Configuration</a></li>
                <li><a href="docker.html">Docker</a></li>
                <li><a href="faq.html">FAQ</a></li>
                <li><a href="knowledge.html">Knowledge</a></li>
                <li><a href="https://github.com/kstawiski/rtpipeline" class="nav-github" target="_blank">
                    <svg height="20" viewBox="0 0 16 16" width="20" fill="currentColor">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                    </svg>
                    GitHub
                </a></li>
            </ul>
            <button class="nav-toggle" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <header class="page-header">
        <div class="container">
            <h1>Output Format</h1>
            <p>Understand every artefact RTpipeline writes under <code>Data_Snakemake/</code> so you can trace results with confidence.</p>
        </div>
    </header>

    <main class="content">
        <div class="container">
            <section class="feature-detail" id="structure">
                <div class="feature-detail-header">
                    <div class="feature-detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        </svg>
                    </div>
                    <h2>Directory Layout</h2>
                </div>
                <div class="feature-detail-content">
                    <p class="feature-intro">
                        The Snakemake workflow writes every result beneath <strong><code>Data_Snakemake/</code></strong> by default. Each patient has one or more course folders that collect imaging, segmentations, analytics, and QC metadata.
                    </p>
                    <div class="code-block directory-tree">
                        <pre><code>Data_Snakemake/
├── _RESULTS/                           <span class="comment"># Cohort-level Excel/JSON summaries</span>
├── Patient001/
│   └── 2024-01-15/                     <span class="comment"># Course ID (from StudyDate or plan)</span>
│       ├── DICOM/
│       │   ├── CT/…                    <span class="comment">Planning CT slices</span>
│       │   ├── MR/…                    <span class="comment">MR linked via REG objects</span>
│       │   ├── RTPLAN/ RP*.dcm
│       │   ├── RTDOSE/ RD*.dcm
│       │   └── RTSTRUCT/ RS*.dcm
│       ├── NIFTI/                      <span class="comment">CT (and RTDOSE) converted by dcm2niix</span>
│       ├── MR/
│       │   └── &lt;SeriesUID&gt;/
│       │       ├── DICOM/…
│       │       ├── NIFTI/*.nii.gz
│       │       └── Segmentation_TotalSegmentator/ total_mr--&lt;roi&gt;.nii.gz
│       ├── Segmentation_TotalSegmentator/
│       │   ├── total--&lt;roi&gt;.nii.gz
│       │   └── manifests + RTSTRUCT (<code>total.dcm</code>)
│       ├── Segmentation_CustomModels/&lt;model&gt;/…
│       ├── Segmentation_Original/…     <span class="comment">Manual RTSTRUCT converted to masks</span>
│       ├── RS.dcm | RS_auto.dcm | RS_auto_cropped.dcm | RS_custom.dcm
│       ├── radiomics_ct.xlsx           <span class="comment">Per-course CT features</span>
│       ├── MR/radiomics_mr.xlsx        <span class="comment">Per-course MR features</span>
│       ├── dvh_metrics.xlsx            <span class="comment">Course-level DVH workbook</span>
│       ├── fractions.xlsx              <span class="comment">Fraction/MU log if RTPLAN present</span>
│       ├── metadata/case_metadata.xlsx
│       ├── qc_reports/*.json
│       └── cropping_metadata.json      <span class="comment">Present when systematic CT cropping enabled</span>
└── Patient002/…
</code></pre>
                    </div>
                </div>
            </section>

            <section class="feature-detail" id="artefacts">
                <div class="feature-detail-header">
                    <div class="feature-detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <path d="M3 9h18M9 21V9"/>
                        </svg>
                    </div>
                    <h2>Per-Course Artefacts</h2>
                </div>
                <div class="feature-detail-content">
                    <div class="output-grid">
                        <article class="output-card">
                            <h3>DICOM & NIfTI</h3>
                            <p>Every CT, MR, RTPLAN, RTDOSE, and RTSTRUCT file referenced by a course is copied under <code>DICOM/</code>. NIfTI conversions with metadata JSON live under <code>NIFTI/</code> (CT/dose) and <code>MR/*/NIFTI</code>.</p>
                            <ul>
                                <li><code>metadata/nifti_conversion.json</code> records dcm2niix provenance.</li>
                                <li>MR NIfTI JSON stores <code>SeriesInstanceUID</code>, voxel spacing, and original path.</li>
                            </ul>
                        </article>
                        <article class="output-card">
                            <h3>Segmentation</h3>
                            <p>TotalSegmentator outputs populate <code>Segmentation_TotalSegmentator/</code> plus the RTSTRUCT <code>total.dcm</code>. Custom nnU-Net runs write into <code>Segmentation_CustomModels/&lt;name&gt;</code> with manifests listing exported ROIs.</p>
                            <ul>
                                <li>Manual RTSTRUCTs converted to masks live in <code>Segmentation_Original/</code>.</li>
                                <li><code>manifest.json</code> files describe model versions and ROI names.</li>
                            </ul>
                        </article>
                        <article class="output-card">
                            <h3>Analytics</h3>
                            <p>Each course receives <code>dvh_metrics.xlsx</code>, <code>fractions.xlsx</code> (plan + MU info), <code>radiomics_ct.xlsx</code>, and <code>MR/radiomics_mr.xlsx</code>. Optional robustness runs add <code>radiomics_robustness_ct.parquet</code>.</p>
                            <ul>
                                <li>Files record <code>Segmentation_Source</code> so manual vs automated ROIs remain distinguishable.</li>
                                <li>Radiomics workbooks follow the PyRadiomics IBSI feature naming scheme.</li>
                            </ul>
                        </article>
                        <article class="output-card">
                            <h3>Quality Control</h3>
                            <p><code>qc_reports/*.json</code> summarise checks (cropped ROIs, missing RTDOSE, UID mismatches). The <code>metadata/</code> folder stores case-level facts such as detected modalities and custom-structure warnings.</p>
                            <ul>
                                <li>Status levels: PASS · INFO · WARNING · FAIL.</li>
                                <li>Use <code>_RESULTS/qc_reports.xlsx</code> for cohort overviews.</li>
                            </ul>
                        </article>
                    </div>
                </div>
            </section>

            <section class="feature-detail" id="rtstruct">
                <div class="feature-detail-header">
                    <div class="feature-detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M2 12h20M12 2v20"/>
                        </svg>
                    </div>
                    <h2>RTSTRUCT Variants</h2>
                </div>
                <div class="feature-detail-content">
                    <p>RTpipeline keeps every contour provenance so you can choose the appropriate dataset for DVH, radiomics, or QA.</p>
                    <div class="table-responsive">
                        <table class="rtstruct-table">
                            <thead>
                                <tr>
                                    <th>File</th>
                                    <th>Source</th>
                                    <th>Purpose</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>RS.dcm</code></td>
                                    <td>Copied intact from the hospital export during the organise stage.</td>
                                    <td>Physician contours for audits, manual DVHs, or comparison against automation.</td>
                                </tr>
                                <tr>
                                    <td><code>RS_auto.dcm</code></td>
                                    <td>TotalSegmentator CT inference on the full image grid.</td>
                                    <td>Automated organ set. Default source for auto DVH/radiomics when cropping is disabled.</td>
                                </tr>
                                <tr>
                                    <td><code>RS_auto_cropped.dcm</code></td>
                                    <td>TotalSegmentator masks intersected with the systematic cropping box.</td>
                                    <td>Ensures voxel counts match cropped CTs when <code>ct_cropping.use_cropped_for_*</code> is true.</td>
                                </tr>
                                <tr>
                                    <td><code>RS_custom.dcm</code></td>
                                    <td><code>structure_merger.py</code> (manual + auto + <code>custom_structures*.yaml</code> Boolean rules).</td>
                                    <td>Clean superset with derived ROIs (bowel bag, iliac vessels, etc.); default input for DVH/radiomics.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section class="feature-detail" id="aggregated">
                <div class="feature-detail-header">
                    <div class="feature-detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16v16H4z"/>
                            <path d="M4 9h16M9 4v16"/>
                        </svg>
                    </div>
                    <h2>_RESULTS Cohort Folder</h2>
                </div>
                <div class="feature-detail-content">
                    <p>The <code>_RESULTS/</code> directory stitches every course into spreadsheets ready for statistics, plotting, or import into REDCap/R.</p>
                    <ul class="aggregated-list">
                        <li><strong><code>dvh_metrics.xlsx</code></strong> – DVH metrics for all structures with <code>patient_id</code>, <code>course_id</code>, <code>Segmentation_Source</code>, and cropping flags.</li>
                        <li><strong><code>radiomics_ct.xlsx</code></strong> / <strong><code>radiomics_mr.xlsx</code></strong> – Merged PyRadiomics features (IBSI naming) plus provenance columns.</li>
                        <li><strong><code>fractions.xlsx</code></strong> – Beam IDs, energies, monitor units, and cumulative dose per fraction when RTPLAN/RTRECORDs are present.</li>
                        <li><strong><code>case_metadata.xlsx</code></strong> – Quick view of detected modalities, registration counts, segmentation availability, and runtime stats.</li>
                        <li><strong><code>qc_reports.xlsx</code></strong> – Flattened QC log for dashboards.</li>
                        <li><strong><code>radiomics_robustness_summary.xlsx</code></strong> – ICC/CoV/QCD tiers per feature when robustness is enabled.</li>
                    </ul>
                </div>
            </section>

            <section class="feature-detail" id="columns">
                <div class="feature-detail-header">
                    <div class="feature-detail-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 3h14M5 9h14M5 15h14M5 21h14"/>
                        </svg>
                    </div>
                    <h2>Key Columns & Flags</h2>
                </div>
                <div class="feature-detail-content">
                    <div class="table-responsive">
                        <table class="output-table">
                            <thead>
                                <tr>
                                    <th>File</th>
                                    <th>Column</th>
                                    <th>Meaning</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>dvh_metrics.xlsx</code></td>
                                    <td><code>Segmentation_Source</code></td>
                                    <td>Manual, AutoTS_total, AutoTS_total_mr, Custom, CustomModel:&lt;name&gt;, etc.</td>
                                </tr>
                                <tr>
                                    <td><code>dvh_metrics.xlsx</code></td>
                                    <td><code>structure_cropped</code></td>
                                    <td><code>true</code> if an ROI touches the cropping box boundary (treat as partial volume).</td>
                                </tr>
                                <tr>
                                    <td><code>dvh_metrics.xlsx</code></td>
                                    <td><code>DxxGy / VxxGy_% / VxxGy_cc</code></td>
                                    <td>Standard DVH statistics calculated with dicompyler-core (units noted in header).</td>
                                </tr>
                                <tr>
                                    <td><code>radiomics_ct.xlsx</code></td>
                                    <td><code>roi_name</code>, <code>segmentation_source</code></td>
                                    <td>Human-readable label and provenance used for cohort filtering.</td>
                                </tr>
                                <tr>
                                    <td><code>radiomics_ct.xlsx</code></td>
                                    <td><code>structure_cropped</code></td>
                                    <td>Flag inherited from DVH/QC to simplify exclusion of truncated volumes.</td>
                                </tr>
                                <tr>
                                    <td><code>radiomics_robustness_summary.xlsx</code></td>
                                    <td><code>icc_score / cov_pct / tier</code></td>
                                    <td>ICC(3,1), percent CoV, and auto-assigned tier (Robust/Acceptable/Poor) per feature and ROI.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p>Before downstream modelling, filter out <code>structure_cropped == true</code>, review QC statuses, and document which <code>Segmentation_Source</code> values you kept.</p>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <span class="logo-icon">RT</span>
                    <span class="logo-text">pipeline</span>
                </div>
                <p>Open source radiotherapy DICOM processing pipeline.</p>
                <div class="footer-links">
                    <a href="https://github.com/kstawiski/rtpipeline" target="_blank">GitHub</a>
                    <a href="https://github.com/kstawiski/rtpipeline/issues" target="_blank">Issues</a>
                    <a href="https://github.com/kstawiski/rtpipeline/blob/master/LICENSE" target="_blank">License</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 RTpipeline. Released under MIT License.</p>
            </div>
        </div>
    </footer>

    <script src="assets/js/main.js"></script>
</body>
</html>
